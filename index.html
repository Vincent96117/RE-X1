<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>V1.5 å˜ç©ºå›æ¸¬å¯¦é©—å®¤ (éˆæ•åº¦å¯èª¿ç‰ˆ)</title>
    <style>
        :root { --bg: #0b0e11; --card: #181a20; --ready: #f0b90b; --entry: #f6465d; --hold: #2ebd85; --text: #eaecef; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; padding: 20px; line-height: 1.6; }
        .box { background: var(--card); padding: 20px; border-radius: 10px; border: 1px solid #333; margin-bottom: 20px; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; }
        input[type="text"], input[type="number"], select { background: #333; color: #fff; border: 1px solid #555; padding: 8px; border-radius: 5px; width: 100%; box-sizing: border-box; }
        button { background: var(--ready); color: #000; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th { background: #1e2329; color: #848e9c; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #2b2f36; }
        .win { color: var(--hold); font-weight: bold; }
        .loss { color: var(--entry); }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center; }
        .summary-item { background: #222; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="box">
    <h2 style="color:var(--ready); margin-top:0;">V1.5 å˜ç©ºå›æ¸¬å¯¦é©—å®¤</h2>
    <div class="controls">
        <div>
            <label>å¹£ç¨®åç¨± (USDT çµå°¾)</label>
            <input type="text" id="symbol" value="DUSKUSDT">
        </div>
        <div>
            <label>çµæ§‹é€±æœŸ (å¤©)</label>
            <select id="lookbackDays">
                <option value="3">3 å¤© (éˆæ• - æŠ“å°æµª)</option>
                <option value="5">5 å¤© (ä¸­åº¸)</option>
                <option value="7" selected>7 å¤© (ç©©å¥ - æŠ“å¤§è‚‰)</option>
            </select>
        </div>
        <div>
            <label>è³‡è²»é–€æª» (%)</label>
            <input type="number" id="fundThreshold" value="-0.03" step="0.01">
        </div>
    </div>
    <button onclick="runBacktest()">ğŸ”¥ åŸ·è¡Œéˆæ•åº¦å›æ¸¬</button>
    <div id="loading" style="text-align:center; margin-top:10px; color:var(--ready);"></div>
</div>

<div id="result-summary" class="box" style="display:none;">
    <div class="summary-grid">
        <div class="summary-item"><div id="totalHits" style="font-size:20px; font-weight:bold;">0</div><div>è§¸ç™¼æ¬¡æ•¸</div></div>
        <div class="summary-item"><div id="avgProfit" style="font-size:20px; font-weight:bold; color:var(--hold);">0%</div><div>å¹³å‡æœ€å¤§æ¼²å¹…</div></div>
        <div class="summary-item"><div id="winRate" style="font-size:20px; font-weight:bold; color:var(--ready);">0%</div><div>å™´ç™¼æˆåŠŸç‡ (>3%)</div></div>
    </div>
</div>

<table id="result-table">
    <thead>
        <tr>
            <th>æ—¥æœŸ</th>
            <th>çªç ´é»ä½</th>
            <th>ç•¶æ™‚è³‡è²»</th>
            <th>24h æœ€å¤§æ¼²å¹…</th>
            <th>ç‹€æ…‹</th>
        </tr>
    </thead>
    <tbody id="result-list"></tbody>
</table>

<script>
    async function runBacktest() {
        const symbol = document.getElementById('symbol').value.toUpperCase();
        const lookbackDays = parseInt(document.getElementById('lookbackDays').value);
        const fundThreshold = parseFloat(document.getElementById('fundThreshold').value);
        const loading = document.getElementById('loading');
        const list = document.getElementById('result-list');
        
        // æ¸…ç©ºèˆŠæ•¸æ“š
        loading.innerText = "ğŸ“… æ­£åœ¨ç©¿è¶Šæ™‚ç©ºæŠ“å–æ­·å²æ•¸æ“š...";
        list.innerHTML = "";
        document.getElementById('result-summary').style.display = "none";

        try {
            // æŠ“å– 4H æ•¸æ“š (å¹£å®‰ä¸Šé™ 500 æ ¹ = ç´„ 83 å¤©)
            const kRes = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=4h&limit=500`);
            const kData = await kRes.json();
            
            // æŠ“å–è³‡è²»ç´€éŒ„
            const fRes = await fetch(`https://fapi.binance.com/fapi/v1/fundingRate?symbol=${symbol}&limit=500`);
            const fData = await fRes.json();

            const lookbackPeriods = (lookbackDays * 24) / 4; // å¤©æ•¸è½‰ç‚º 4H æ ¹æ•¸
            let hits = 0;
            let totalProfit = 0;
            let wins = 0;

            for (let i = lookbackPeriods; i < kData.length - 6; i++) {
                const currentK = kData[i];
                const highRecent = Math.max(...kData.slice(i - lookbackPeriods, i).map(k => parseFloat(k[2])));
                const currentHigh = parseFloat(currentK[2]);
                const time = currentK[0];

                // é»ç«æ¢ä»¶ï¼šçªç ´çµæ§‹é«˜é»
                if (currentHigh > highRecent * 1.001) {
                    const funding = fData.find(f => Math.abs(f.fundingTime - time) < 7200000); // æ‰¾ 2hr å…§çš„è³‡è²»
                    const fRate = funding ? parseFloat(funding.fundingRate) * 100 : 0;

                    // ç‡ƒæ–™æ¢ä»¶ï¼šè³‡è²»æ˜¯å¦ä½æ–¼é–€æª»
                    if (fRate <= fundThreshold) {
                        hits++;
                        // è¿½è¹¤å¾ŒçºŒ 24h æœ€é«˜é»
                        const futureK = kData.slice(i, i + 6);
                        const maxFuture = Math.max(...futureK.map(k => parseFloat(k[2])));
                        const profit = ((maxFuture - highRecent) / highRecent * 100);
                        
                        if (profit > 3) wins++;
                        totalProfit += profit;

                        const date = new Date(time).toLocaleDateString();
                        const row = `
                            <tr>
                                <td>${date}</td>
                                <td>${highRecent.toFixed(4)}</td>
                                <td style="color:#00ffff">${fRate.toFixed(4)}%</td>
                                <td class="${profit > 5 ? 'win' : (profit < 0 ? 'loss' : '')}">${profit.toFixed(2)}%</td>
                                <td>${profit > 5 ? 'ğŸš€ æš´åŠ›å¤§å˜' : (profit > 0 ? 'âœ… å°å¹…ç²åˆ©' : 'âŒ å‡çªç ´')}</td>
                            </tr>
                        `;
                        list.insertAdjacentHTML('beforeend', row);
                    }
                }
            }

            // æ›´æ–°ç¸½çµ
            if (hits > 0) {
                document.getElementById('totalHits').innerText = hits;
                document.getElementById('avgProfit').innerText = (totalProfit / hits).toFixed(2) + "%";
                document.getElementById('winRate').innerText = ((wins / hits) * 100).toFixed(0) + "%";
                document.getElementById('result-summary').style.display = "block";
            }
            loading.innerText = hits > 0 ? "âœ… å›æ¸¬å®Œæˆ" : "âš ï¸ æ¢ä»¶å¤ªåš´è‹›ï¼Œé€™æ®µæ™‚é–“æ²’äººé»ç«";

        } catch (e) {
            loading.innerText = "âŒ éŒ¯èª¤ï¼šè«‹ç¢ºèªå¹£ç¨®åç¨±æ­£ç¢ºï¼ˆå¦‚ BOMEUSDTï¼‰";
        }
    }
</script>
</body>
</html>
